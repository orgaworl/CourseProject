# Merkle Patricia Trie (MPT)

## 介绍

Merkle tree 在计算机科学中是一种树形数据结构，用于校验数据完整性和有效性，并且被广泛的应用于区块链网络中. 比特币便是使用Merkle tree 安全地验证交易内容. 而Ethereum中使用Merkle Patricia Trie保存每笔交易的key-value对, 校验数据正确性.

相对MT, 使用MPT来进行查询拥有共同前缀key的数据时十分高效. 例如在字典中查找前缀为x的key，对于MT需要遍历整个表，时间效率为O(n)，而对于MPT只需要在树中找到前缀为x的节点，并遍历以这个节点为根节点的子树即可。



## 基础知识

### Trie

字典树, 保存关联数组key-value对. 其中key由根节点到节点的路径决定.

### Patricia Trie

字典树的改进版本, 将只有单个子节点的路径压缩为一个点, 相比Trie空间占用更小.

### Merkel Trie

**叶子节点**的value是数据项的内容；

**非叶子节点**的value根据其孩子节点的信息，经过特定Hash算法计算得出的；

在bitcoin实际应用中, 将相邻两个节点的哈希值合并成一个字符串，然后计算这个字符串的哈希，得到这两个节点的父节点的哈希值。

**优势**:

- 快速重哈希: 树节点内容发生改变时, 只需重新哈希修改的树节点便可以得到新的根哈希值.

**劣势**: 

- 存储空间开销大
  
  

### Merkle Patricia Trie

MPT树结合了字典树和默克尔树的优点，在压缩字典树中根节点是空的，而MPT树可以在根节点保存整棵树的哈希校验和，而校验和的生成则是采用了和默克尔树生成一致的方式。

**优势**:

- 查找迅速
- 节省存储

**劣势**: 

- 存
  
  

## 以太坊MPT

以太坊模型保存数据为key-value对结构, 一次交易需要保存大量该数据结构.

以太坊采用MPT树来保存交易、交易的收据以及世界状态，为了压缩整体的树高，降低操作的复杂度，以太坊对MPT树进行了一些优化。将树节点分成了四种:

* 空节点（hashNode）
  空字符串

* 分支节点（fullNode）    : pointer+value
  前16个元素代表nibble的16种可能.
  当存在一个key-value对在此结束,则最后一个元素为其中的value.

* 扩展节点（shortNode）: prefix + shared nibble +next nodes
  第一元素prefix用以区分叶节点和拓展节点.
  第二元素代表相同的多个nibble.
  第三元素用以链接其他节点.

* 叶子节点（valueNode）: prefix + key-end + value
  第一个元素prefix.
  第二个元素存储一个key-value对.
  
  

<img title="" src=".\\picture\\MPT.png" alt="MPT" style="zoom:30%;">

prefix 属性取值

| 取值  | 含义            |
| --- | ------------- |
| 0   | 偶数个16进制数的扩展节点 |
| 1□  | 奇数个16进制数的扩展节点 |
| 2   | 偶数个半字节叶节点     |
| 3□  | 奇数个半字节叶节点     |

其中□为第一个半字节
